name: Build and Release Windows EXE

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
      id-token: write  # Required for keyless signing with cosign

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Install MAUI Workload
      run: dotnet workload install maui

    - name: Restore dependencies
      run: dotnet restore SUS.EOS.NeoWallet/SUS.EOS.NeoWallet/SUS.EOS.NeoWallet.WinUI/SUS.EOS.NeoWallet.WinUI.csproj

    - name: Build and Publish Self-Contained EXE
      run: |
        dotnet publish SUS.EOS.NeoWallet/SUS.EOS.NeoWallet/SUS.EOS.NeoWallet.WinUI/SUS.EOS.NeoWallet.WinUI.csproj `
          -c Release `
          -r win-x64 `
          --self-contained true `
          -p:PublishSingleFile=true `
          -p:PublishTrimmed=true `
          -p:WindowsPackageType=None `
          -o ./publish/win-x64

    - name: Handle Versioning for Branch Push
      if: github.ref_type == 'branch'
      run: |
        $version = Get-Content VERSION -Raw
        $parts = $version.Trim().Split('.')
        $patch = [int]$parts[2] + 1
        $newVersion = "$($parts[0]).$($parts[1]).$patch"
        $newVersion | Out-File VERSION -NoNewline
        Write-Host "New version: $newVersion"
        echo "NEW_VERSION=$newVersion" >> $env:GITHUB_ENV

    - name: Set Version
      run: |
        if ($env:GITHUB_REF_TYPE -eq 'tag') {
          echo "VERSION=$env:GITHUB_REF_NAME" >> $env:GITHUB_ENV
        } else {
          echo "VERSION=$env:NEW_VERSION" >> $env:GITHUB_ENV
        }

    - name: Commit Version Bump
      if: github.ref_type == 'branch'
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add VERSION
        git commit -m "Bump version to ${{ env.NEW_VERSION }}" || echo "No changes to commit"
        git push origin main

    - name: Create Tag
      if: github.ref_type == 'branch'
      run: |
        git tag v${{ env.NEW_VERSION }}
        git push origin v${{ env.NEW_VERSION }}

    # - name: Install Cosign
    #   run: |
    #     Invoke-WebRequest -Uri https://github.com/sigstore/cosign/releases/download/v2.4.0/cosign-windows-amd64.exe -OutFile cosign.exe

    # - name: Sign ZIP with Cosign
    #   env:
    #     COSIGN_EXPERIMENTAL: 1
    #   run: |
    #     ./cosign.exe sign-blob --keyless --oidc-issuer https://token.actions.githubusercontent.com --yes NeoWallet-${{ env.VERSION }}.zip

    - name: Create Release
      if: github.ref_type == 'tag'
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: Release ${{ github.ref_name }}
        draft: false
        prerelease: false

    - name: Upload Release Asset
      if: github.ref_type == 'tag'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./NeoWallet-${{ env.VERSION }}.zip
        asset_name: NeoWallet-${{ env.VERSION }}.zip
        asset_content_type: application/zip

    # - name: Upload Signature
    #   if: github.ref_type == 'tag'
    #   uses: actions/upload-release-asset@v1
    #   env:
    #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    #   with:
    #     upload_url: ${{ steps.create_release.outputs.upload_url }}
    #     asset_path: ./NeoWallet-${{ env.VERSION }}.zip.sig
    #     asset_name: NeoWallet-${{ env.VERSION }}.zip.sig
    #     asset_content_type: application/octet-stream

    # - name: Check if Certificate Exists
    #   if: github.ref_type == 'tag'
    #   id: cert_check
    #   run: |
    #     if [ -f "NeoWallet-${{ env.VERSION }}.zip.cert" ]; then
    #       echo "cert_exists=true" >> $GITHUB_OUTPUT
    #     else
    #       echo "cert_exists=false" >> $GITHUB_OUTPUT
    #     fi

    # - name: Upload Certificate
    #   if: steps.cert_check.outputs.cert_exists == 'true' && github.ref_type == 'tag'
    #   uses: actions/upload-release-asset@v1
    #   env:
    #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    #   with:
    #     upload_url: ${{ steps.create_release.outputs.upload_url }}
    #     asset_path: ./NeoWallet-${{ env.VERSION }}.zip.cert
    #     asset_name: NeoWallet-${{ env.VERSION }}.zip.cert
    #     asset_content_type: application/octet-stream